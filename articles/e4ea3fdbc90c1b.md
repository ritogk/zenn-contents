---
title: "é­šã®ãŸã‚ã®ã‚¯ã‚½éŸ³æ¥½ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œã£ãŸ"
emoji: "ğŸŸ"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Javascript", "TypeScript", "vue", "WebAudioAPI", "frontend"]
published: true
published_at: 2023-12-21 00:01
---

ã“ã®è¨˜äº‹ã¯[ã‚¯ã‚½ã‚¢ãƒ—ãƒª Advent Calendar 2023](https://qiita.com/advent-calendar/2023/kuso-app)Â ã®21æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

# ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã¯é­šã«éŸ³æ¥½ã‚’èã‹ã›ãŸã„ã¨æ€ã£ãŸäº‹ã¯ã‚ã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ
ã‚ãŸã—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã¨ã„ã†äº‹ã§ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

# ä½œã£ãŸã‚‚ã®

æ¥½æ›²ã‚’ç‰¹å®šã®é­šã®ãŸã‚ã ã‘ã«ç‰¹åŒ–ã—ã¦å†ç”Ÿã§ãã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
https://fish-beat.homisoftware.net
![](/images/e4ea3fdbc90c1b/1.png)

# ä½¿ã„æ–¹

1. æ¥½æ›²é¸æŠ
2. å‹•ç‰©ã‚’é¸æŠ
3. å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã™
4. ç«¯æœ«ã®éŸ³é‡ã‚’ã€Œ`15å€`ã€ã«ã™ã‚‹

https://youtu.be/PLTEZnu7Mls?si=DYh3Ibywv2QvnILw
å€‹äººçš„ã«ãƒ–ãƒªã®éŸ³ãŒå¥½ãã§ã™ã€‚

# é­šã®éŸ³ã®èã“ãˆæ–¹

å¤šãã®é­šãŸã¡ã¯2~3000hzã®ç¯„å›²ã§ã—ã‹éŸ³ãŒèã“ãˆã¾ã›ã‚“ã€‚
ã¾ãŸé­šã«ã‚ˆã£ã¦å‘¨æ³¢æ•°æ¯ã®dbæ„Ÿåº¦ãŒé•ã£ãŸã‚Šã—ã¾ã™ã€‚
é‡‘é­šã¨ãƒ–ãƒªã‚’ä¾‹ã«ä¸Šã’ã‚‹ã¨ã€é‡‘é­šã¯100hzã®å‘¨æ³¢æ•°ã‚’90dbã§èãã¨ã‚Œã¾ã™ãŒã€ãƒ–ãƒªã¯110dbã§ãªã„ã¨èãå–ã‚Œã¾ã›ã‚“ã€‚
ãã‚Œã¨æ¯”ã¹ã¦äººé–“ã®è€³ã¯é«˜æ€§èƒ½ã§ã€20hz~20000hzã®ç¯„å›²ã‚’èãå–ã‚‹äº‹ãŒã§ãã€100~10000hzã®å‘¨æ³¢æ•°ã‚’50dbä»¥ä¸‹ã§èãå–ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

å›³ã§è¡¨ã™ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚
![](/images/e4ea3fdbc90c1b/2.png)

# ã“ã®ã‚¢ãƒ—ãƒªã§ã—ã¦ã„ã‚‹ã“ã¨

äººé–“ã¨é­šã®éŸ³ã®èã“ãˆæ–¹ã®å·®ã‚’ã¨ã‚Šã€ãã®å·®ã‚’å¢—å¹…ã•ã›ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚
æ¥½æ›²ã¯äººé–“ãƒ™ãƒ¼ã‚¹ãªã®ã§ã€ãã®å·®ã‚’åŸ‹ã‚ã¦ã—ã¾ãˆã°ã€ãŸã¶ã‚“é­šå¥½ã¿ã®éŸ³ã«ãªã‚‹ã®ã‹ãªã‚ã¨ã€‚
ã‚¨ãƒ•ã‚§ã‚¯ã‚¿ãƒ¼ã¿ãŸã„ãªç‰©ã ã¨æ€ãˆã°ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

# å®Ÿè£…

æ¥½æ›²ã‚’WebAudioAPIã§èª­ã¿è¾¼ã¾ã›ã€é­šæ¯ã«ç”¨æ„ã—ãŸBiquadFilterNodeã§éŸ³ã‚’åŠ å·¥ã—ã¦å†ç”Ÿã—ã¦ã„ã¾ã™ã€‚

## é‡‘é­šã«æœ€é©åŒ–ã—ãŸéŸ³ã‚’ä½œã‚‹

ã¾ãšã€äººé–“ã¨é‡‘é­šã®å‘¨æ³¢æ•°æ¯ã§ã‚®ãƒªã‚®ãƒªèãå–ã‚Œã‚‹dbä¸€è¦§ã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx
const reactionFrequencyAnimals = {
    name: 'äººé–“',
    auditoryPressure: [
      { frequency: 100, db: 50 },
      { frequency: 200, db: 40 },
      { frequency: 300, db: 35 },
      { frequency: 400, db: 32 },
      { frequency: 500, db: 30 },
      { frequency: 600, db: 29 },
      { frequency: 700, db: 29 },
      { frequency: 800, db: 28 },
      { frequency: 900, db: 28 },
      { frequency: 1000, db: 28 },
      { frequency: 2000, db: 26 },
      { frequency: 3000, db: 18 },
      { frequency: 4000, db: 28 },
      { frequency: 5000, db: 31 },
      { frequency: 6000, db: 34 },
      { frequency: 7000, db: 38 },
      { frequency: 8000, db: 42 },
      { frequency: 9000, db: 45 }
    ]
  },
  {
    name: 'é‡‘é­š',
    auditoryPressure: [
      { frequency: 100, db: 88 },
      { frequency: 200, db: 72 },
      { frequency: 300, db: 69 },
      { frequency: 400, db: 62 },
      { frequency: 500, db: 62 },
      { frequency: 600, db: 62 },
      { frequency: 700, db: 62 },
      { frequency: 800, db: 62 },
      { frequency: 900, db: 62 },
      { frequency: 1000, db: 63 },
      { frequency: 2000, db: 80 },
      { frequency: 3000, db: 95 },
      { frequency: 4000, db: 115 }
    ]
  },
```

å†ç”Ÿã™ã‚‹éŸ³æºã¯äººé–“ãƒ™ãƒ¼ã‚¹ãªã®ã§é‡‘é­šã«ã¯èãå–ã‚Œãªã„å‘¨æ³¢æ•°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
é‡‘é­šã¯100~4000hzã®ç¯„å›²ã§ã—ã‹èãå–ã‚Œãªã„ã®ã§ã€ä¸ç”¨ãªå‘¨æ³¢æ•°ã‚’ã‚«ãƒƒãƒˆã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx
const targetAnimal = "é‡‘é­š";
// äººé–“ã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
const humanReaction = reactionFrequencyAnimals.find(
  (animal) => animal.name === "äººé–“"
);
// é‡‘é­šã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å–å¾—
const targetReaction = reactionFrequencyAnimals.find(
  (animal) => animal.name === targetAnimal
);
// é‡‘é­šãŒèãå–ã‚Œã‚‹æœ€å°å‘¨æ³¢æ•°ã‚’å–å¾—
const minFrequency = targetReaction.auditoryPressure.reduce((prev, current) =>
  prev.frequency < current.frequency ? prev : current
).frequency;
// é‡‘é­šãŒèãå–ã‚Œã‚‹æœ€å¤§å‘¨æ³¢æ•°ã‚’å–å¾—
const maxFrequency = targetReaction.auditoryPressure.reduce((prev, current) =>
  prev.frequency > current.frequency ? prev : current
).frequency;

// é‡‘é­šç”¨ã®æœ€å°å‘¨æ³¢æ•°~æœ€å¤§å‘¨æ³¢æ•°ã‚’åˆ‡ã‚Šå‡ºã™ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½œæˆã™ã‚‹ã€‚
const biquadFilter = this._audioContext.createBiquadFilter();
biquadFilter.type = "bandpass";
const centerFrequency = Math.sqrt(minFrequency * maxFrequency);
const QValue = centerFrequency / (maxFrequency - minFrequency);
biquadFilter.frequency.value = centerFrequency;
biquadFilter.Q.value = QValue;
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç´ä»˜ã‘ã‚‹
this._gainNode.connect(biquadFilter);
```

æ¬¡ã«ã€éŸ³é‡ã‚’èª¿æ•´ã™ã‚‹ãŸã‚ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
é‡‘é­šã¯äººé–“ã¨æ¯”ã¹ã‚‹ã¨è€³ãŒæ‚ªãã€60dbä»¥ä¸Šã§ãªã„ã¨èãå–ã‚Œã¾ã›ã‚“ã€‚
ã¾ãŸã€å‘¨æ³¢æ•°æ¯ã«èãå–ã‚Œã‚‹dbã‚‚é•ã£ã¦ã„ã‚‹ãŸã‚ã€èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
æ¥½æ›²ã¯äººé–“ãƒ™ãƒ¼ã‚¹ã§ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ãªã®ã§ã€å‘¨æ³¢æ•°æ¯ã®äººé–“ã¨é‡‘é­šã®dbå·®ã‚’æ±‚ã‚ã€æ¥½æ›²ã®å‘¨æ³¢æ•°æ¯ã®éŸ³é‡ã‚’å¢—åŠ ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```tsx
let lastNode = biquadFilter
for (const filterConfig of targetReaction.auditoryPressure) {
  const filter = this._audioContext.createBiquadFilter()
  // é‡‘é­šã®å‘¨æ³¢æ•°ã¨ä¸€è‡´ã™ã‚‹äººé–“ã®å‘¨æ³¢æ•°ã‚’å–ã‚Šå‡ºã™ã€‚
  const humanAuditoryPressure = humanReaction.auditoryPressure.find(
    (human) => human.frequency === filterConfig.frequency
  )
	// é‡‘é­šdb - äººé–“dbã®å·®ã‚’ã‚²ã‚¤ãƒ³ã«å¤‰æ›ã€‚
  const gain = calculateSoundPressureLevelGain(humanAuditoryPressure.db, filterConfig.db)
  // ãã®ã¾ã¾ã®å€¤ã‚’ä½¿ã†ã¨éŸ³é‡ã‚’30å€~7000å€ã‚ã’ã¦ã—ã¾ã†ã®ã§éŸ³ãŒå£Šã‚Œãªã„ç¯„å›²ã«èª¿æ•´ã™ã‚‹(120å€ä»¥ä¸Šã¯è«¦ã‚ã‚‹)
  const adjustedGain = (gain / 15) < 8 : (gain / 15) : 8
  filter.type = 'peaking'
  filter.frequency.value = filterConfig.frequency
  filter.gain.value = adjustedGain
	// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ç´ä»˜ã‘ã‚‹ã€‚
  lastNode.connect(filter)
  lastNode = filter
}
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’ç´ä»˜ã‘ã‚‹
lastNode.connect(this._audioContext.destination)
```

## ã‹ãªã—ã‹ã£ãŸäº‹

é‡‘é­šã®è€³ãŒæ‚ªã™ãã‚‹ã›ã„ã§ã€ã‚¢ãƒ—ãƒªåˆ¶å¾¡ã ã‘ã§æœ€é©ãªéŸ³é‡ã«èª¿æ•´ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
é‡‘é­šã«æœ€é©åŒ–ã™ã‚‹ãŸã‚ã«ã¯æœ€ä½ã§ã‚‚éŸ³é‡ã‚’30å€ä»¥ä¸Šå¢—å¹…ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã€å˜ç´”ã«30å€ã—ã¦ã—ã¾ã†ã¨éŸ³ãŒã¤ã¶ã‚Œã¦ã—ã¾ã†ã®ã§ã©ã†ã—ã‚ˆã†ã‚‚ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
ãªã®ã§å®Ÿè£…ã§ã¯ã€å…ƒã®å€¤ã‚’15ã§å‰²ã£ãŸå€¤ã§å¢—å¹…ã•ã›ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œ`ãƒ›ã‚¹ãƒˆç«¯æœ«ã®éŸ³é‡ã‚’15å€ã«ã™ã‚‹ä½œæ¥­`ã€ã—ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚Šã€ãƒ›ã‚¹ãƒˆã«é ¼ã‚Šãã£ãŸã‚¯ã‚½ã‚’é€šã‚Šè¶Šã™ã‚¯ã‚½ã‚¯ã‚½ã‚¢ãƒ—ãƒªã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

## æ‚ªã„äº‹ã‚’æ€ã„ã¤ã„ãŸ

Web Audio Apiã®ã‚²ã‚¤ãƒ³ã®æœ€å¤§å€¤ã¯1541ãªã®ã§ã€å˜ç´”ã«1541å€ã¾ã§å¢—å¹…ã§ãã‚‹ã‚‰ã—ã„ã€‚
ãªã®ã§ã€1541å€ã—ãŸéŸ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ç´ã¥ã‘ã¦å†ç”Ÿã•ã›ãŸã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‚’ã¶ã£å£Šã™äº‹ãŒã§ãã‚‹ã®ã§ã¯ã¨æ€ã„ã¾ã—ãŸã€‚
ã²ã‚ˆã£ã¦400å€ã§ãŸã‚ã—ãŸã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ­¢ã‚ã¦ãã‚Œã¾ã—ãŸã€‚ã‚„ã•ã—ã„ã€‚
@[tweet](https://twitter.com/ritoweb0321/status/1732567921778655307?s=20)
100å€ãªã‚‰å†ç”Ÿã§ãã¾ã—ãŸãŒã€ãƒ›ã‚¹ãƒˆéŸ³é‡2ã§ã¯è€ƒãˆã‚‰ã‚Œãªã„éŸ³é‡ã ã£ãŸã®ã§ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã«è² è·ã¯ã‹ã‹ã£ã¦ãã†ã€‚

# ãŠã‚ã‚Šã«

ã¯ã˜ã‚ã¦ã®ã‚¯ã‚½ã‚¢ãƒ—ãƒªåˆ¶ä½œã§ã—ãŸã€‚
ã¾ã£ãŸãä¾¡å€¤ã®ãªã„ã‚¢ãƒ—ãƒªã§æ‚©ã‚“ã§ã„ã‚‹æ™‚é–“ãŒã‚ˆãã‚ã‹ã‚‰ãªãã¦æ¥½ã—ã‹ã£ãŸã§ã™ã€‚

å®Œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://github.com/ritogk/fish-beat

# å‚è€ƒæ–‡çŒ®

[é­šã®æ°´ä¸­éŸ³æ„Ÿè¦šã¨é‡£ã‚Šã¸ã®å¿œç”¨](https://www.jstage.jst.go.jp/article/sicejl/58/1/58_25/_pdf)
