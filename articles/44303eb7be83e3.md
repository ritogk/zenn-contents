---
title: "OenaAPIgeneratorで生成したコードをlaravelでいい感じに使ってインターフェースを守る" # 記事のタイトル
emoji: "👶" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["OpenAPI", "laravel"] # トピックス（タグ）["markdown", "rust", "aws"]のように指定する
published: false # 公開設定（falseにすると下書き）
---

# 概要
openapi generatorで生成したコードをlaravelで良い感じに使えたので  
generatorの設定とかをメモとして残しておきます。  

# バージョン
Laravel 8.55.0  
OpenAPI 3.0.0  


# ディレクトリ構成
├── open_api_generator  
│   ├── api.yaml  
│   ├── config_php.json  
│   └── generator_php.sh  
└── project  
    ├── app  
    │   ├── Http  
    │   │   ├── Controllers  
    │   │   │   ├── Api  
    │   │   │   │   └── Master  
    │   │   │   │       └── JobCategoryController.php  
    │   │   │   └── Controller.php  
    │   │   └── Requests  
    │   │       └── Master  
    │   │           └── JobCategoryListRequest.php  
    │   ├── Libs  
    │   │   └── OpenAPIUtility.php  
    │   ├── Models  
    │   │   └── JobCategory.php  
    │   └── OpenAPI(自動正された子達)  
    │       ├── Api  
    │       │   └── DefaultApi.php  
    │       ├── ApiException.php  
    │       ├── Configuration.php  
    │       ├── HeaderSelector.php  
    │       ├── Model  
    │       │   ├── JobCategory.php  
    │       │   ├── ModelInterface.php  
    │       │   ├── QueryJobCategoryList.php  
    │       │   └── Sex.php  
    │       ├── ObjectSerializer.php  
    │       └── api.yaml  
    └── routes  
        └── api.php  


# OpenAPI generator
laravel用のジェネレーターではなくphp用のジェネレーターを使用します。
laravel用のジェネレーターはルートとコントローラーが作られるだけでリクエストとレスポンス関係のコードは何も作られません。
php用の方はうまく使えばリクエストとレスポンスがある程度保証できます。

```config_php.json
{
    "invokerPackage": "App\\OpenAPI",   # 自動生成されたコードをおく場所に合わせて変更してください。
    "variableNamingConvention": "camel_case"
}
```

```php_generator.sh
OUTPUT_PATH='/out/php'
docker run --rm -v ${PWD}:/local openapitools/openapi-generator-cli generate -i /local/api.yaml -g php -o /local${OUTPUT_PATH} -c /local/config_php.json

# enumで定義した定数名の前になぜか「NUMBER_」が追加されるので削除
grep -l 'NUMBER_' .${OUTPUT_PATH}/lib/Model/* | xargs sed -i 's/NUMBER_//g'

# laravel側に必要なファイルをコピー
mkdir -p ../project/app/OpenAPI
cp -r ./out/php/lib/* ../project/app/OpenAPI
cp api.yaml ../project/app/OpenAPI

# 作業ファイル削除
rm -rf ./out
```

```api.yaml
~~~~
```
このコマンドを実行するとコードが生成されます。
モデルのみ使用。


# Laravel
```JobController.php
public function create(JobRequest $request, CreateAction $action): JsonResponse
{
    # リクエストを自動生成したモデルに変換
    $parameters = new OpenAPI\Model\RequestJob($request->all());
    # メインロジック
    $result = $action(
        $parameters->getTitle(),
        $parameters->getContent(),
        $parameters->getAttention(),
        $parameters->getJobCategoryId(),
        $parameters->getPrice(),
        $parameters->getWelfare(),
        $parameters->getHoliday(),
        $parameters->getImage(),
        $parameters->getSortNo()
    );
    # 自動生成したモデルに変換してからレスポンスを返す
    return response()->json(
        OpenAPIUtility::dicstionaryToModelContainer(OpenAPI\Model\Job::class, $result),
        Response::HTTP_CREATED
    );
}
```
やってる事はコントローラーに入ってくるリクエストと、レスポンスをopenapi定義と合わせるようにしただけ。
これでlaravelの自由度を残しながらそれなりにインターフェースの保証ができるようになります。

# 言われそうな事
openapi定義とlaravelのルートとリクエストクラスを合わせるのがめんどくさい。
→サーバーサイド側がapi作ると思うので頑張って合わせてください。

Openapi定義のsecurity?とかヘッダーとか保障されてなくね？
→されません。Openapiで表現できる以上の事をlaravelのルートで制御できるので、まあ良いかなあと。あくまでlaravelが主。





▫️前提
generator
公式のgeneratorでphp-laravelがでていますが、は使えないというか使いにくいから使わない。
自動生成されたコードは入口のパラメーターと出口のレスポンスを保障するためだけに使う。



自動生成されたコードは入口のパラメーターと出口のレスポンスを保障するためだけに使う。

バージョン7、自由度がなくなる。
ジェネレーターにはphpを仕様
これだとlaravelの自由度？を残しつつ、いい感じにopenapi定義を使える

▫️バージョン

▫️openapi
クエリパラメータ、リクエストボディはモデル化しておく

▫️openapi-generator
php-laravelではなく、phpを使う。
名前空間をlaravelに合わせて変更する。
キャメルケースかスネークケースかはお好みで。

▫️laravel
コントローラーの入口と出口にモデルを挟み込む。
これでメインロジックとレスポンスの内容がopenapi定義のモデルで保障される。

▫️言われそうな事
openapi定義とlaravelのルートとリクエストクラスを合わせるのがめんどくさい。
→サーバーサイド側がapi作ると思うので頑張って合わせてください。

Openapi定義のsecurity?とか保障されてなくね？
→されてません。Openapiで表現できる事　以上の事がlaravelのルートで設定できるからまあ良いかなあと。

完璧じゃないけど、laravelの自由度を残しながらできるから良いよね。

クエリパラメータ、ボディパラメータ類の
モデルを作って、
コントローラーの入口と出口を定義モデルに成形して返してる。

パラメーター類を
