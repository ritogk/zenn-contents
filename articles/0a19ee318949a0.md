---
title: "å€‹äººé–‹ç™ºã§ãŠé‡‘ã‚’ã‹ã‘ãšã«localhostã‚’httpsã®å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã§å…¬é–‹ã™ã‚‹ã€‚"
emoji: "ğŸ“Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ngrok", "nginx", "vps"]
published: true
---

# ã¯ã˜ã‚ã«
webé–‹ç™ºã¯`sslåŒ–ã•ã‚ŒãŸå›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã§webå…¬é–‹ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹`ã§é–‹ç™ºã—ãŸã„ã¨æ€ã†æ–¹ãŒå¤šã„ã¨æ€ã„ã¾ã™ã€‚
ãã®ç†ç”±ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹apiã‚’å©ãéš›ã«sslåŒ–ã•ã‚ŒãŸå›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã§ãªã„ã¨å‹•ã‹ãªã‹ã£ãŸã‚Šã€ã‚¹ãƒãƒ›ã§å‹•ä½œç¢ºèªã—ãŸã„ã‚ˆã†ãªå ´é¢ã«ã‚ˆãé­é‡ã™ã‚‹ã‹ã‚‰ã§ã™ã€‚
ngrokã®ã‚ˆã†ãªãƒˆãƒ³ãƒãƒªãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã†ã¨æ‰‹ã£å–ã‚Šæ—©ãè§£æ±ºã—ã¾ã™ãŒæœˆ10$ã¨ãã‚Œãªã‚Šã«ãŠé‡‘ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã€å€‹äººé–‹ç™ºã®ã‚ˆã†ãªå£²ä¸Šåº¦å¤–è¦–ã§ã‚„ã£ã¦ã„ã‚‹ã¨ãŸã‚ã‚‰ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã§ã€ä¸Šè¨˜ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹`ãŠé‡‘ã‚’ã‹ã‘ãªã„ç‚¹ã‚’é‡è¦–`ã—ã¦`sslåŒ–ã•ã‚ŒãŸå›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã¨localhostã®ç´ã¥ã‘`ã‚’è¡Œã£ãŸã®ã§å…±æœ‰ã—ã¾ã™ã€‚

# å‰ææ¡ä»¶
- vpsã‚’æ‰€æœ‰ã—ã¦ã„ã¦vpså†…ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã—ã¦ã„ã‚‹ã€‚
- ãƒˆãƒ³ãƒãƒªãƒ³ã‚°ç”¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–å¾—æ¸ˆã€‚
- dnsã®è¨­å®šã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å‚ç…§å…ˆã‚’vpsã«å‘ã‘ã¦ã„ã‚‹ã€‚

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
```mermaid

sequenceDiagram
	autonumber
	client->>vps: request https://å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³
	vps->>vps: nginxã§localhost:8000ã¸ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·
 
	opt ï¾„ï¾ï¾ˆï¾˜ï¾ï½¸ï¾(localhost:8000 â‡” localhost:8000)
	  vps->>localãƒã‚·ãƒ³: localãƒã‚·ãƒ³ã®localhost:8000ã«ãƒ‡ãƒ¼ã‚¿ã‚’æµã™
		localãƒã‚·ãƒ³->>vps: response
  end
  vps->>client: reponse
```

ã‚„ã£ã¦ã„ã‚‹äº‹ã¯VPSå†…ã®nginxã§å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’localhost:8000ã«ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã—ã¦ã€VPSã®localhost:8000ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã®localhost:8000ã‚’ãƒˆãƒ³ãƒãƒªãƒ³ã‚°ã—ç¹‹ã’ã¦ã€å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã®localhost:8000ã‚’ç¹‹ã’ã¦ã„ã¾ã™ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã¨VPSã¯å¸¸ã«ç¹‹ãŒã£ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªããƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‹ã‚‰ã®ã‚ã‚‹ã‚³ãƒãƒ³ãƒ‰1ã¤ã§ãƒˆãƒ³ãƒãƒªãƒ³ã‚°ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã®ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé•ã†å¤–å‡ºå…ˆã‚„è‡ªå®…ã§ã‚‚ã‚³ãƒãƒ³ãƒ‰1ã¤ã§å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã‚’ç¹‹ã’ã‚‹äº‹ãŒã§ãã¾ã™ã€‚

VPSã®ä¸­ã§ã¯ä½œã£ãŸã‚¢ãƒ—ãƒªã¨ä¸Šè¨˜ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãŒæ··åœ¨ã™ã‚‹ã‚ˆã†ãªå½¢ã«ãªã‚‹ã®ã§ã‚´ãƒãƒ£ã£ã¨ã—ã¾ã™ãŒãã“ã¯å¦¥å”ã—ã¾ã™ã€‚

# VPSå´ã®è¨­å®š
## nginx
ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ã£ã¦å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’localhost:8000ã«è»¢é€ã—ã¾ã™ã€‚
é–‹ç™ºä¸­ã«ä»–äººã«è¦‹ã‚‰ã‚Œã¦ã¯å›°ã‚‹ã®ã§allowã¨denyã§è‡ªèº«ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã®ã¿ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚
sslã®è¨­å®šã¯Let's Encryptã§è‡ªå‹•ç”Ÿæˆã™ã‚‹ã®ã§ã“ã“ã§ã¯æ›¸ãã¾ã›ã‚“ã€‚

```bash
server {
    server_name tunneling8000.homisoftware.net;
    listen 80;
    listen [::]:80;

    access_log /var/log/nginx/tunneling8000/access.log;
    error_log /var/log/nginx/tunneling8000/error.log error;

    allow xx.xx.xx.xx;  # è‡ªå®…IP
    deny all;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã®SSLåŒ–
Certbotã‚’ä½¿ã£ã¦å›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã®SSLåŒ–ã‚’è¡Œã„ã¾ã™ã€‚
Certbotã¯ç„¡æ–™ã‹ã¤è‡ªå‹•ã§SSLè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
```bash
sudo apt install certbot
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è¨¼æ˜æ›¸ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚
```bash
sudo certbot --nginx -d tunneling8000.homisoftware.net
```

è¨¼æ˜æ›¸ç™ºè¡Œå¾Œã«nginxã®confãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•çš„ã«æ›¸ãæ›ã‚ã‚Šã¾ã™ã€‚
```bash
server {
    server_name tunneling8000.homisoftware.net;

    access_log /var/log/nginx/tunneling8000/access.log;
    error_log /var/log/nginx/tunneling8000/error.log error;

    allow xx.xx.xx.xx;  # è‡ªå®…IP
    deny all;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/tunneling8000.homisoftware.net/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/tunneling8000.homisoftware.net/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
    if ($host = tunneling8000.homisoftware.net) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    server_name tunneling8000.homisoftware.net;
    listen 80;
    listen [::]:80;
    return 404; # managed by Certbot

}
```

# ãƒ­ãƒ¼ã‚«ãƒã‚·ãƒ³å´ã®è¨­å®š
## vpsã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ç¹‹ã’ã‚‹
sshã®ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ã£ã¦VPSå´ã®localhost:8000ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³å´ã®localhost:8000ã‚’ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ç¹‹ã’ã¾ã™ã€‚
é•·æ™‚é–“æ¥ç¶šãŒãªã„å ´åˆã«ãƒªãƒ¢ãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ãŒåˆ‡æ–­ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã‹ã©ã†ã‹ã¯ãŠå¥½ã¿ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚

```bash
Host xserver-tunneling8000
  HostName xxx.xxx.xxx.xxx
  IdentityFile ~/.ssh/xxx.pem
  User ubuntu
  RemoteForward 8000 localhost:8000
  ServerAliveInterval 60  #é€šä¿¡ãŒé•·æ™‚é–“ãªã„å ´åˆã«åˆ‡æ–­ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
  ServerAliveCountMax 5   #é€šä¿¡ãŒé•·æ™‚é–“ãªã„å ´åˆã«åˆ‡æ–­ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
```

ã‚ã¨ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§vpså´ã®localhost:8000ã¨localhost:8000ã®ç´ã¥ã‘ãŒã•ã‚Œã¦sslåŒ–ã•ã‚ŒãŸå›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã¨localhost:8000ãŒç´ã¥ãã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```bash
ssh -N xserver-tunneling8000
```

# ãŠã‚ã‚Šã«
1ã¤ã®vpså†…ã§è‰²ã€…ã‚„ã‚‰ã›éãæ„ŸãŒã‚ã‚Šã¾ã™ãŒç„¡æ–™ã§å…¬é–‹ã—ã¦ã„ã‚‹ã‚ˆã†ãªã‚†ã‚‹ã„å€‹äººé–‹ç™ºãªã‚‰ã“ã‚“ãªã‚“ã§ã‚‚ã„ã„ã‚“ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹ã€‚
vercelã®ã‚ˆã†ãªãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ãˆã°ç°¡å˜ã«sslåŒ–ã•ã‚ŒãŸå›ºå®šãƒ‰ãƒ¡ã‚¤ãƒ³ã§webå…¬é–‹ãŒã§ãã¾ã™ãŒã€ç„¡æ–™ã§3ã‚¢ãƒ—ãƒªã¾ã§ã—ã‹ä½œã‚Œãªã‹ã£ãŸã‚Šã¨åˆ¶é™ãŒã‚ã‚Šã€è‡ªç”±ã«é–‹ç™ºã—ãŸã‹ã£ãŸã®ã§ä»Šå›ã¯ã“ã£ã¡ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

ã©ã“ã‹ã®èª°ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚