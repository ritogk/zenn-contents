---
title: "ソーシャル認証と一般的なパスワード認証を組み合わせたサーバーサイドの設計"
emoji: "😽"
type: "tech"
topics: ["oauth2", "oauth", "flask"] #
published: true
---

# はじめに
一般的なユーザー名とパスワードを使った認証とoauth2を使った認証の組み合わせたサーバー側の設計のメモです。

以降は「ユーザー名とパスワードを使った認証」を「パスワード認証」 とします。

# 全体的な考え方
認証方式をあまり意識したくないので認証後はサーバー側がユーザーの識別子を含むjwtを発行する。
サーバーはリクエスト内に含まれるjwtを検証して認証済かどうかの判断を行う。
新規登録とログインの処理はパスワード認証用とoauth2用で2つ作る必要あり。
oauth2のアクセストークンとリフレッシュトークンは保持しない。使ったらすぐに破棄(こわいので)

# table定義
## users
ユーザーの基本情報
|  id  |  name  |  email  |
| ---- | ---- | ---- |
|  1  |  佐藤学  |  satomanabu@manabun.com  |

## user_authentications
パスワード認証用の情報
|  id  |  user_id   |  username  |  password  |
| ---- | ---- | ---- | ---- |
|  1  |  1  |  manabu  |  51fd726f3d3f93f8d436b7e6c060...  |

## user_oauths
oauth2で認証を行うための情報
|  id  |  user_id   |  provider  |  identity  |
| ---- | ---- | ---- | ---- |
|  1  |  1  |  google  |  10001  |

provider = oauthのプロバイダ名
identity = 認可されたプロバイダ側のユーザー識別子(user_idとか)

# パスワード認証のフロー
## 新規登録
```mermaid
sequenceDiagram
	autonumber
	client->>server: 新規登録要 要求<br>{name, email, username, password}
    server->>db.users: ユーザー登録<br>{name, email}
    server->>db.user_authentications: ユーザー登録<br>{users.id, username, password}
    server->>server: users.idを含むjwtを生成
    server->>client: set-cookie jwt<br>httponly=True, expires=2日
```

## ログイン
```mermaid
sequenceDiagram
	autonumber
	client->>server: ログインリ 要求<br>{username, password}
    server->>db.user_authentications: ユーザー名とパスワードで認証
    server->>db.users: ユーザー情報 要求
    db.users->>server: ユーザー情報
    server->>server: users.idを含むjwtを生成
    server->>client: set-cookie jwt<br>httponly=True, expires=2日
```

# oauth2認証のフロー
## 新規登録
```mermaid
sequenceDiagram
	autonumber
	client->>server: oauthプロバイダーの認可画面URLを要求
    server->>client: 認可画面URLを返却
    client->>oauth_認可: リダイレクト
    oauth_認可->>client: 認可コード返却
    client->>server: 新規登録 要求<br>{code}
    server->>oauth_認可: アクセストークン要求<br>{code}
    oauth_認可->>server: アクセストークン返却
    server->>oauth_リソース: ユーザー情報要求<br>{access_token}
    oauth_リソース->>server: ユーザー情報返却
    server->>db.users: ユーザー登録
    server->>db.user_oauths: ユーザー登録
    server->>server: users.idを含むjwtを生成
    server->>client: set-cookie jwt<br>httponly=True, expires=2日
```

## ログイン
リソースサーバーからユーザー情報を取得するまでは新規登録と同じ。
```mermaid
sequenceDiagram
	autonumber
	client->>server: oauthプロバイダーの認可画面URLを要求
    server->>client: 認可画面URLを返却
    client->>oauth_認可: リダイレクト
    oauth_認可->>client: 認可コード返却
    client->>server: 新規登録 要求<br>{code}
    server->>oauth_認可: アクセストークン要求<br>{code}
    oauth_認可->>server: アクセストークン返却
    server->>oauth_リソース: ユーザー情報要求<br>{access_token}
    oauth_リソース->>server: ユーザー情報返却
    server->>db.user_oauths: provider名と認可されたプロバイダ側のユーザー識別子で認証
    server->>db.users: ユーザー情報 要求
    db.users->>server: ユーザー情報
    server->>server: users.idを含むjwtを生成
    server->>client: set-cookie jwt<br>httponly=True, expires=2日
```

# おわりに
多分これで問題ないと思うけどどうなんでしょう・・・