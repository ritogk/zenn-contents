---
title: "ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼ã¨ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’çµ„ã¿åˆã‚ã›ãŸã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®è¨­è¨ˆ"
emoji: "ğŸ˜½"
type: "tech"
topics: ["oauth2", "oauth", "flask"] #
published: true
---

# ã¯ã˜ã‚ã«
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã¨ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼ã‚’çµ„ã¿åˆã‚ã›ãŸã‚µãƒ¼ãƒãƒ¼å´ã®è¨­è¨ˆãƒ¡ãƒ¢ã§ã™ã€‚
â€»ã€Œä¸€èˆ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸèªè¨¼ã€ã‚’ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã€ ã¨ç•¥ã—ã¦ã„ã¾ã™ã€‚

flaskã§å®Ÿè£…ã—ãŸã‚µãƒ³ãƒ—ãƒ«
https://github.com/ritogk/social-login-sample




# å…¨ä½“çš„ãªè€ƒãˆæ–¹
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§èªè¨¼æ–¹å¼ã‚’æ„è­˜ã—ãŸããªã„ã®ã§èªè¨¼å¾Œã¯ã‚µãƒ¼ãƒãƒ¼å´ãŒèªè¨¼æƒ…å ±(ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­ã‚’å«ã‚€jwt)ã‚’ç™ºè¡Œã™ã‚‹ã€‚
ã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã«å«ã¾ã‚Œã‚‹jwtã‚’æ¤œè¨¼ã—ã¦èªè¨¼æ¸ˆã‹ã©ã†ã‹ã®åˆ¤æ–­ã‚’è¡Œã†ã€‚
æ–°è¦ç™»éŒ²ã¨ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”¨ã¨ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼ç”¨ã§2ã¤ä½œã‚‹å¿…è¦ã‚ã‚Šã€‚
ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼æ™‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¿æŒã—ãªã„ã€‚ä½¿ã£ãŸã‚‰ã™ãã«ç ´æ£„(ã“ã‚ã„ã®ã§)


# tableå®šç¾©
## users
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŸºæœ¬æƒ…å ±
ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼ã®å ´åˆã¯oauthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå…¥ã‚‹
|  id  |  name  |  email  |
| ---- | ---- | ---- |
|  1  |  ä½è—¤å­¦  |  satomanabu@manabun.com  |

## user_authentications
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”¨ã®æƒ…å ±
|  id  |  user_id   |  username  |  password  |
| ---- | ---- | ---- | ---- |
|  1  |  1  |  manabu  |  51fd726f3d3f93f8d436b7e6c060...  |

## user_oauths
ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼ç”¨ã®æƒ…å ±
|  id  |  user_id   |  provider  |  identity  |
| ---- | ---- | ---- | ---- |
|  1  |  1  |  google  |  10001  |

provider = oauthã®ãƒ—ãƒ­ãƒã‚¤ãƒ€å
identity = èªå¯ã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€å´ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­(user_idã¨ã‹)

# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã®ãƒ•ãƒ­ãƒ¼
## æ–°è¦ç™»éŒ²
```mermaid
sequenceDiagram
	autonumber
	client->>server: æ–°è¦ç™»éŒ²è¦ è¦æ±‚<br>param: {name, email, username, password}
    server->>db.users: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²<br>param: {name, email}
    server->>db.user_authentications: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²<br>param: {users.id, username, password}
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

## ãƒ­ã‚°ã‚¤ãƒ³
```mermaid
sequenceDiagram
	autonumber
	client->>server: ãƒ­ã‚°ã‚¤ãƒ³ è¦æ±‚<br>param: {username, password}
    server->>db.user_authentications: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼
    server->>db.users: èªè¨¼æ¸ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± è¦æ±‚<br>
    db.users->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± è¿”å´
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

# oauth2èªè¨¼ã®ãƒ•ãƒ­ãƒ¼
## æ–°è¦ç™»éŒ²
```mermaid
sequenceDiagram
	autonumber
	client->>server: oauthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®èªå¯ç”»é¢URLã‚’è¦æ±‚
    server->>client: èªå¯ç”»é¢URLã‚’è¿”å´
    client->>oauth_èªå¯: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    oauth_èªå¯->>client: èªå¯ã‚³ãƒ¼ãƒ‰è¿”å´
    client->>server: æ–°è¦ç™»éŒ² è¦æ±‚<br>param: {code}
    server->>oauth_èªå¯: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¦æ±‚<br>param: {code}
    oauth_èªå¯->>server: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¿”å´
    server->>oauth_ãƒªã‚½ãƒ¼ã‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± è¦æ±‚<br>param: {access_token}
    oauth_ãƒªã‚½ãƒ¼ã‚¹->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± è¿”å´ â€»1
    server->>db.users: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²<br>param: {â€»1.name, â€»1.email}
    server->>db.user_oauths: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²<br>param: {'google', â€»1.ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­}
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

## ãƒ­ã‚°ã‚¤ãƒ³
```mermaid
sequenceDiagram
	autonumber
	client->>server: oauthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®èªå¯ç”»é¢URLã‚’è¦æ±‚
    server->>client: èªå¯ç”»é¢URLã‚’è¿”å´
    client->>oauth_èªå¯: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    oauth_èªå¯->>client: èªå¯ã‚³ãƒ¼ãƒ‰è¿”å´
    client->>server: æ–°è¦ç™»éŒ² è¦æ±‚<br>param: {code}
    server->>oauth_èªå¯: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¦æ±‚<br>param: {code}
    oauth_èªå¯->>server: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¿”å´
    server->>oauth_ãƒªã‚½ãƒ¼ã‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¦æ±‚<br>param: {access_token}
    oauth_ãƒªã‚½ãƒ¼ã‚¹->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¿”å´ â€»1
    server->>db.user_oauths: ã€Œprovideråã€ã¨ã€Œâ€»1.ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­ã€ã§èªè¨¼
    server->>db.users: èªè¨¼æ¸ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± è¦æ±‚
    db.users->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

# ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ(ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã€oauth2èªè¨¼ã§å…±é€š)
```mermaid
sequenceDiagram
	autonumber
	client->>server: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ è¦æ±‚
    server->>client: set-cookie jwt=''
```

# ãŠã‚ã‚Šã«
å¤šåˆ†ã“ã‚Œã§å•é¡Œãªã„ã¨æ€ã†ã§ã™ã‘ã©ã©ã†ãªã‚“ã§ã—ã‚‡ãƒ»ãƒ»ãƒ»ãƒ»