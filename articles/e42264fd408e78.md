---
title: "ã‚½ãƒ¼ã‚·ãƒ£ãƒ«èªè¨¼ã¨ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’çµ„ã¿åˆã‚ã›ãŸã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®è¨­è¨ˆ"
emoji: "ğŸ˜½"
type: "tech"
topics: ["oauth2", "oauth", "flask"] #
published: true
---

# ã¯ã˜ã‚ã«
ä¸€èˆ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸèªè¨¼ã¨oauth2ã‚’ä½¿ã£ãŸèªè¨¼ã®çµ„ã¿åˆã‚ã›ãŸã‚µãƒ¼ãƒãƒ¼å´ã®è¨­è¨ˆã®ãƒ¡ãƒ¢ã§ã™ã€‚

ä»¥é™ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸèªè¨¼ã€ã‚’ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã€ ã¨ã—ã¾ã™ã€‚

# å…¨ä½“çš„ãªè€ƒãˆæ–¹
èªè¨¼æ–¹å¼ã‚’ã‚ã¾ã‚Šæ„è­˜ã—ãŸããªã„ã®ã§èªè¨¼å¾Œã¯ã‚µãƒ¼ãƒãƒ¼å´ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­˜åˆ¥å­ã‚’å«ã‚€jwtã‚’ç™ºè¡Œã™ã‚‹ã€‚
ã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã«å«ã¾ã‚Œã‚‹jwtã‚’æ¤œè¨¼ã—ã¦èªè¨¼æ¸ˆã‹ã©ã†ã‹ã®åˆ¤æ–­ã‚’è¡Œã†ã€‚
æ–°è¦ç™»éŒ²ã¨ãƒ­ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”¨ã¨oauth2ç”¨ã§2ã¤ä½œã‚‹å¿…è¦ã‚ã‚Šã€‚
oauth2ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¿æŒã—ãªã„ã€‚ä½¿ã£ãŸã‚‰ã™ãã«ç ´æ£„(ã“ã‚ã„ã®ã§)

# tableå®šç¾©
## users
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŸºæœ¬æƒ…å ±
|  id  |  name  |  email  |
| ---- | ---- | ---- |
|  1  |  ä½è—¤å­¦  |  satomanabu@manabun.com  |

## user_authentications
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”¨ã®æƒ…å ±
|  id  |  user_id   |  username  |  password  |
| ---- | ---- | ---- | ---- |
|  1  |  1  |  manabu  |  51fd726f3d3f93f8d436b7e6c060...  |

## user_oauths
oauth2ã§èªè¨¼ã‚’è¡Œã†ãŸã‚ã®æƒ…å ±
|  id  |  user_id   |  provider  |  identity  |
| ---- | ---- | ---- | ---- |
|  1  |  1  |  google  |  10001  |

provider = oauthã®ãƒ—ãƒ­ãƒã‚¤ãƒ€å
identity = èªå¯ã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€å´ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­(user_idã¨ã‹)

# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã®ãƒ•ãƒ­ãƒ¼
## æ–°è¦ç™»éŒ²
```mermaid
sequenceDiagram
	autonumber
	client->>server: æ–°è¦ç™»éŒ²è¦ è¦æ±‚<br>{name, email, username, password}
    server->>db.users: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²<br>{name, email}
    server->>db.user_authentications: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²<br>{users.id, username, password}
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

## ãƒ­ã‚°ã‚¤ãƒ³
```mermaid
sequenceDiagram
	autonumber
	client->>server: ãƒ­ã‚°ã‚¤ãƒ³ãƒª è¦æ±‚<br>{username, password}
    server->>db.user_authentications: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼
    server->>db.users: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± è¦æ±‚
    db.users->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

# oauth2èªè¨¼ã®ãƒ•ãƒ­ãƒ¼
## æ–°è¦ç™»éŒ²
```mermaid
sequenceDiagram
	autonumber
	client->>server: oauthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®èªå¯ç”»é¢URLã‚’è¦æ±‚
    server->>client: èªå¯ç”»é¢URLã‚’è¿”å´
    client->>oauth_èªå¯: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    oauth_èªå¯->>client: èªå¯ã‚³ãƒ¼ãƒ‰è¿”å´
    client->>server: æ–°è¦ç™»éŒ² è¦æ±‚<br>{code}
    server->>oauth_èªå¯: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¦æ±‚<br>{code}
    oauth_èªå¯->>server: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¿”å´
    server->>oauth_ãƒªã‚½ãƒ¼ã‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¦æ±‚<br>{access_token}
    oauth_ãƒªã‚½ãƒ¼ã‚¹->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¿”å´
    server->>db.users: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    server->>db.user_oauths: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

## ãƒ­ã‚°ã‚¤ãƒ³
ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã¾ã§ã¯æ–°è¦ç™»éŒ²ã¨åŒã˜ã€‚
```mermaid
sequenceDiagram
	autonumber
	client->>server: oauthãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®èªå¯ç”»é¢URLã‚’è¦æ±‚
    server->>client: èªå¯ç”»é¢URLã‚’è¿”å´
    client->>oauth_èªå¯: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    oauth_èªå¯->>client: èªå¯ã‚³ãƒ¼ãƒ‰è¿”å´
    client->>server: æ–°è¦ç™»éŒ² è¦æ±‚<br>{code}
    server->>oauth_èªå¯: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¦æ±‚<br>{code}
    oauth_èªå¯->>server: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³è¿”å´
    server->>oauth_ãƒªã‚½ãƒ¼ã‚¹: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¦æ±‚<br>{access_token}
    oauth_ãƒªã‚½ãƒ¼ã‚¹->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¿”å´
    server->>db.user_oauths: provideråã¨èªå¯ã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€å´ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­ã§èªè¨¼
    server->>db.users: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± è¦æ±‚
    db.users->>server: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
    server->>server: users.idã‚’å«ã‚€jwtã‚’ç”Ÿæˆ
    server->>client: set-cookie jwt<br>httponly=True, expires=2æ—¥
```

# ãŠã‚ã‚Šã«
å¤šåˆ†ã“ã‚Œã§å•é¡Œãªã„ã¨æ€ã†ã‘ã©ã©ã†ãªã‚“ã§ã—ã‚‡ã†ãƒ»ãƒ»ãƒ»