---
title: "ãƒ­ãƒ¼ã‚«ãƒ«å®Œçµã§æ—¥æœ¬å…¨å›½ã®æ¨™é«˜ã‚’ç·¯åº¦çµŒåº¦æŒ‡å®šã§å–å¾—ã§ãã‚‹ç’°å¢ƒã‚’ä½œã‚‹"
emoji: "ğŸ”ï¸"
type: "tech"
topics: ["Python", "gis", "OpenStreetMap", "GDAL"]
published: true
published_at: 2024-12-10 00:01
---

## å¤§é‡ã®ç·¯åº¦çµŒåº¦ã«ç´ã¥ãæ¨™é«˜å€¤ã‚’å–å¾—ã—ãŸã„

### å•é¡Œ

å›½åœŸåœ°ç†é™¢ã•ã‚“ã‹ã‚‰[ç·¯åº¦çµŒåº¦ã«ç´ã¥ãæ¨™é«˜å€¤ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®API](https://maps.gsi.go.jp/development/elevation_s.html?utm_source=chatgpt.com)ãŒç„¡æ–™ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ãŒå¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢ã—ã¦ã¯æ§ãˆã‚‹ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

```
ã‚µãƒ¼ãƒã«éåº¦ã®è² æ‹…ã‚’ä¸ãˆãªã„ã§ãã ã•ã„ã€‚
éåº¦ã®è² æ‹…ã‚’ä¸ãˆã‚‹ã¨åˆ¤æ–­ã—ãŸã‚¢ã‚¯ã‚»ã‚¹ã«ã¤ã„ã¦ã€
å›½åœŸåœ°ç†é™¢ã¯äºˆå‘Šãªãé®æ–­ã‚’è¡Œã†å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
```

ã©ã®ç¨‹åº¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒéåº¦ã®è² è·ãªã®ã‹ã¨ã„ã†ã¨[å…¬å¼ã®å›ç­”](https://github.com/gsi-cyberjapan/gsimaps/issues/31)ã§ã¯1ç§’é–“ã«10å›ç¨‹åº¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸Šé™ã¨ã•ã‚Œã¦ã„ã¦å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯æ§ãˆã‚‹ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚
ãªã®ã§ã€ã¾ã˜ã‚ã«ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦å¤§é‡ã®æ¨™é«˜å€¤ã‚’å–å¾—ã™ã‚‹ã¨æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

æœ€è¿‘å…¬å¼Twitterã§ã“ã®å•é¡Œã«è§¦ã‚Œã¦ã„ã¾ã—ãŸã€‚
https://x.com/gsi_cyberjapan/status/1864856461878399122

åˆ¥ã®æ–¹æ³•ã§[Google Elevation API](https://developers.google.com/maps/documentation/elevation/overview?hl=ja)ã§ã‚‚æ¨™é«˜å€¤ã®å–å¾—ãŒã§ãã¾ã™ãŒã€1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ãŸã‚Š0.7å††ã‹ã‹ã‚‹ã®ã§å¤§é‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šç¶šã‘ã‚‹ã¨ãŠé‡‘ãŒæ°´ã®ã‚ˆã†ã«æº¶ã‘ã¦ã—ã¾ã„ã¾ã™ã€‚

### è§£æ±ºæ–¹æ³•

ãƒ­ãƒ¼ã‚«ãƒ«ã«æ—¥æœ¬å…¨å›½ã®æ¨™é«˜ãƒ¢ãƒ‡ãƒ«ã‚’è½ã¨ã—ã“ã‚“ã§ç·¯åº¦çµŒåº¦æŒ‡å®šã§æ¨™é«˜å€¤ã‚’å–å¾—ã§ãã‚‹ç’°å¢ƒã‚’ä½œã‚‹ã€‚ã“ã‚Œãªã‚‰å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã«è² è·ã‚’ã‹ã‘ãšã«ã™ã¿ã¾ã™ã€‚
æ¨™é«˜ãƒ¢ãƒ‡ãƒ«ã¯å›½åœŸåœ°ç†é™¢ã‹ã‚‰ç„¡æ–™ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã„ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚

## ç’°å¢ƒæ§‹ç¯‰

### å‰ææ¡ä»¶

OS: Windows 11 Home
WSL: ubuntu 22:04
Anaconda ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆ
PCã®ç©ºãå®¹é‡ãŒ500GBãã‚‰ã„æ®‹ã£ã¦ã„ã‚‹äº‹

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’cloneã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚ä¸­ã«ã¯ç’°å¢ƒæ§‹ç¯‰ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨æ¨™é«˜å–å¾—ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/ritogk/japan-local-elevation-api

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
$ tree
â”œâ”€â”€ README.md
â”œâ”€â”€ elevation_env.yml    # Anacondaã®ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ elevation_service.py # æ¨™é«˜å–å¾—ç”¨ã®ã‚¯ãƒ©ã‚¹
â”œâ”€â”€ run.py               # å®Ÿè¡Œç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
â””â”€â”€ tool
    â”œâ”€â”€ cab                    # å›½åœŸåœ°ç†é™¢ã‹ã‚‰DLã—ãŸcabãƒ•ã‚¡ã‚¤ãƒ«ã®ç½®ãå ´
    â”‚Â Â  â””â”€â”€ gitignore
    â”œâ”€â”€ categorizing.sh        # cabãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡ã—ã¦jgd2000ã¨jgd2011ã«ä»•åˆ†ã‘ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â€»1
    â”œâ”€â”€ xml_jgd2000            # â€»1ã§è‡ªå‹•çš„ã«ä»•åˆ†ã‘ã‚‰ã‚Œã‚‹xmléƒ¡
    â”‚Â Â  â””â”€â”€ gitignore
    â”œâ”€â”€ xml_jgd2011            # â€»1ã§è‡ªå‹•çš„ã«ä»•åˆ†ã‘ã‚‰ã‚Œã‚‹xmléƒ¡
    â”‚Â Â  â””â”€â”€ gitignore
    â”œâ”€â”€ tif_jgd_to_epsg4326.py # tifã®epsgã‚³ãƒ¼ãƒ‰ã‚’4326ã«å¤‰æ›ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    â”œâ”€â”€ merge_tif.py           # tifãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    â”œâ”€â”€ tif_jgd2000            # ã‚¨ã‚³ãƒªã‚¹ã®ãƒ„ãƒ¼ãƒ«ã§ç”Ÿæˆã—ãŸtifã®ç½®ãå ´
    â”‚Â Â  â””â”€â”€ gitignore
    â””â”€â”€ tif_jgd2011            # ã‚¨ã‚³ãƒªã‚¹ã®ãƒ„ãƒ¼ãƒ«ã§ç”Ÿæˆã—ãŸtifã®ç½®ãå ´
        â””â”€â”€ gitignore
```

### Pythonã®å®Ÿè¡Œç’°å¢ƒã‚’ä½œæˆ

åœ°ç†ç©ºé–“ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«ã¯Gdalã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã™ãŒã¾ã˜ã‚ã«æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ãƒãƒã‚‹ã®ã§Anacondaã®ä»®æƒ³ç’°å¢ƒã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```python
# ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆ
conda env create -f elevation_env.yml
# gdalãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
python3 -c "import osgeo; print('GDAL is installed.')"
```

### æ¨™é«˜ãƒ¢ãƒ‡ãƒ«ã‚’å–å¾—ã™ã‚‹

[åŸºç›¤åœ°å›³æƒ…å ±æƒ…å ± ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹](https://fgd.gsi.go.jp/download/menu.php)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å…¨å›½ã®çœŒå˜ä½ã®æ¨™é«˜ãƒ¢ãƒ‡ãƒ«ã‚’è½ã¨ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã§çœŒå˜ä½ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã¾ã§é€²ã‚ã¾ã™ã€‚

```
- æ¤œç´¢æ¡ä»¶æŒ‡å®š
    - 10mãƒ¡ãƒƒã‚·ãƒ¥
        - 10Aï¼ˆç«å±±åŸºæœ¬å›³ã®ç­‰é«˜ç·šï¼‰ãƒã‚§ãƒƒã‚¯
        - 10Bï¼ˆåœ°å½¢å›³ã®ç­‰é«˜ç·šï¼‰ãƒã‚§ãƒƒã‚¯
- é¸æŠæ–¹å¼
    - éƒ½é“åºœçœŒã¾ãŸã¯å¸‚åŒºç”ºæ‘ã§é¸æŠ
        - å…¨å›½ ãƒã‚§ãƒƒã‚¯
- ã€Œé¸æŠãƒªã‚¹ãƒˆã«è¿½åŠ ã€ã‚’æŠ¼ä¸‹
- ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªã¸ã€ã‚’æŠ¼ä¸‹
```

| 1                                              | 2                                               |
| ---------------------------------------------- | ----------------------------------------------- |
| ![image.png](/images/541ffbf8e5f64c/image.png) | ![image.png](/images/541ffbf8e5f64c/image1.png) |

ãƒ•ã‚¡ã‚¤ãƒ«ã¯cabå½¢å¼ã§åœ§ç¸®ã•ã‚Œã¦ã„ã¾ã™ã€‚

### å¤‰æ›å‰æº–å‚™

æ¨™é«˜ãƒ¢ãƒ‡ãƒ«å†…ã«ã¯jgd2000ã¨jgd2011å½¢å¼ãŒæ··ã–ã£ãŸçŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚jgd2011ã¯æ±æ—¥æœ¬å¤§éœ‡ç½ã®åœ°æ®»å¤‰å‹•ã‚’åæ˜ ã—ãŸç‰©ã§jgd2000ã¯ãã‚Œã‚ˆã‚Šå‰ã®çŠ¶æ…‹ã®ã‚‚ã®ã§æœ€å¤§6mç¨‹åº¦ã‚ºãƒ¬ã¦ã„ã¾ã™ã€‚
ã“ã®2ã¤ãŒæ··ã–ã£ãŸçŠ¶æ…‹ã ã¨GeoTIFFã«å¤‰æ›ã™ã‚‹éš›ã«é¢å€’ãªäº‹ã«ãªã‚‹ã®ã§äº‹å‰ã«ä»•åˆ†ã‘ã‚’è¡Œã„ã¾ã™ã€‚
æ‰‹ã§ä»•åˆ†ã‘ã‚‹ã¨é¢å€’ãã•ã„ã®ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è‡ªå‹•çš„ä»•åˆ†ã‘ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
DLã—ãŸcabãƒ•ã‚¡ã‚¤ãƒ«éƒ¡ã‚’tool/cabãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
cd tool
./categorizing.sh
# ä»•åˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã€‚xmlãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ºãƒ©ãƒ¼ãƒƒã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
ls xml_jgd2000
ls xml_jgd2011
```

:::details categorizing.sh

```python
# å„ç¨®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
BASE_DIR=$(pwd) # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
CAB_DIR="$BASE_DIR/cab" # CABãƒ•ã‚¡ã‚¤ãƒ«ã®æ ¼ç´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
DEST_DIR="$BASE_DIR/xml_output" # XMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã™ã‚‹å…ˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
TEMP_DIR="$BASE_DIR/temp_extract" # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

# JGDãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ
JGD2000_DIR="$BASE_DIR/xml_jgd2000"
JGD2011_DIR="$BASE_DIR/xml_jgd2011"
mkdir -p "$CAB_DIR" "$TEMP_DIR" "$DEST_DIR" "$JGD2000_DIR" "$JGD2011_DIR"

# ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®é–¢æ•°
print_progress_bar() {
    local progress=$1
    local total=$2
    local percent=$((progress * 100 / total))
    local bars=$((percent / 2)) # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®é•·ã•ã‚’50ã«ã™ã‚‹
    local spaces=$((50 - bars)) # æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹
    printf "\r[%-50s] %d%%" "$(printf '#%.0s' $(seq 1 $bars))$(printf ' %.0s' $(seq 1 $spaces))" "$percent"
}

# CABãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆå–å¾—
CAB_FILES=("$CAB_DIR"/*.cab)
TOTAL_CAB=${#CAB_FILES[@]}
CURRENT_CAB=0

# CABãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
echo "Step 1: Extracting CAB files..."
if [ "$TOTAL_CAB" -eq 0 ]; then
    echo "No CAB files found in $CAB_DIR."
else
    for CAB_FILE in "${CAB_FILES[@]}"; do
        CURRENT_CAB=$((CURRENT_CAB + 1))
        print_progress_bar "$CURRENT_CAB" "$TOTAL_CAB"

        cabextract -d "$TEMP_DIR" "$CAB_FILE" > /dev/null 2>&1
    done
fi
echo ""

# ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆå–å¾—
ZIP_FILES=($(find "$TEMP_DIR" -name "*.zip"))
TOTAL_ZIP=${#ZIP_FILES[@]}
CURRENT_ZIP=0

# ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
echo "Step 2: Extracting ZIP files..."
if [ "$TOTAL_ZIP" -eq 0 ]; then
    echo "No ZIP files found in $TEMP_DIR."
else
    for ZIP_FILE in "${ZIP_FILES[@]}"; do
        CURRENT_ZIP=$((CURRENT_ZIP + 1))
        print_progress_bar "$CURRENT_ZIP" "$TOTAL_ZIP"

        unzip -d "$TEMP_DIR" "$ZIP_FILE" > /dev/null 2>&1
    done
fi
echo ""

# XMLãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»å‹•
echo "Step 3: Moving XML files..."
XML_FILES=($(find "$TEMP_DIR" -name "*.xml"))
TOTAL_XML=${#XML_FILES[@]}
CURRENT_XML=0

if [ "$TOTAL_XML" -eq 0 ]; then
    echo "No XML files found in $TEMP_DIR."
else
    for XML_FILE in "${XML_FILES[@]}"; do
        CURRENT_XML=$((CURRENT_XML + 1))
        print_progress_bar "$CURRENT_XML" "$TOTAL_XML"

        mv "$XML_FILE" "$DEST_DIR"
    done
fi
echo ""

# XMLãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†åˆ¥
echo "Step 4: Sorting XML files into JGD2000 and JGD2011..."
cd "$DEST_DIR" || exit
TOTAL_XML_SORT=$(find . -name "*.xml" | wc -l)
CURRENT_XML_SORT=0

if [ "$TOTAL_XML_SORT" -eq 0 ]; then
    echo "No XML files to sort."
else
    for FILE in *.xml; do
        CURRENT_XML_SORT=$((CURRENT_XML_SORT + 1))
        print_progress_bar "$CURRENT_XML_SORT" "$TOTAL_XML_SORT"

        if grep -q '<gml:Envelope srsName="fguuid:jgd2011.bl">' "$FILE"; then
            mv "$FILE" "$JGD2011_DIR"
        elif grep -q '<gml:Envelope srsName="fguuid:jgd2000.bl">' "$FILE"; then
            mv "$FILE" "$JGD2000_DIR"
        fi
    done
fi
echo ""

# ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤
echo "Step 5: Cleaning up..."
rm -rf "$TEMP_DIR"
echo "Cleanup complete!"

echo "All steps completed successfully!"
```

:::

### GeoTIFFå½¢å¼ã«å¤‰æ›ã™ã‚‹

pythonã‹ã‚‰æ‰±ã„ã‚„ã™ãã™ã‚‹ãŸã‚ã«GMLå½¢å¼(xml)ã‹ã‚‰GeoTIFFå½¢å¼ã«å¤‰æ›ã—ã¾ã™ã€‚
ç¾çŠ¶ubuntuã‹ã‚‰å¤‰æ›ã™ã‚‹æ–¹æ³•ãŒå­˜åœ¨ã—ãªã„ã®ã§[windowsç”¨ã®ã‚¨ã‚³ãƒªã‚¹ã•ã‚“ã®æ¨™é«˜DEMãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ„ãƒ¼ãƒ«](https://www.ecoris.co.jp/contents/demtool.html)ã‚’ä½¿ã„å¤‰æ›ã—ã¾ã™ã€‚
ã“ã®ãƒ„ãƒ¼ãƒ«ã¯JGD2011ã¨JGD2000ãŒæ··åœ¨ã—ã¦ã„ã‚‹ã¨å¤‰æ›ã§ãã¾ã›ã‚“ãŒã€äº‹å‰ã®ä»•åˆ†ã‘ä½œæ¥­ã‚’è¡Œã£ã¦ã„ã‚‹ã®ã§å•é¡Œãªãå¤‰æ›ã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚
windowsã¨ubunutã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãŒé•ã†é–¢ä¿‚ã§windowså´ã«xmlã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã¨é«˜é€Ÿã«å¤‰æ›ã§ãã‚‹ã®ã§`tool/xml_jgd2000`ã¨`tool/xml_jgd2011`ã‚’windowså´ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¦å¤‰æ›ã—ã¾ã™ã€‚
ãƒ„ãƒ¼ãƒ«å†…ã®`å¤‰æ›çµåˆ.vbs`ã‚’èµ·å‹•ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«é¸æŠã™ã‚‹ã¨tifãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚å¤‰æ›ã«ã¯æ•°æ™‚é–“ã»ã©ã‹ã‹ã‚Šã¾ã™ã€‚

```
æŠ•å½±æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
â†’ ç·¯åº¦çµŒåº¦: 0
é™°å½±èµ·çŠ¶å›³ã‚’ä½œæˆã—ã¾ã™ã‹?
â†’ ã„ã„ãˆ
JPGIS(GMLå½¢å¼)ã®å…¥ã£ã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„
â†’ windowså´ã«ã‚³ãƒ”ãƒ¼ã—ãŸxml_jgd2000 or xml_jgd2011ã‚’é¸æŠ
æµ·åŸŸã®æ¨™é«˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
â†’ ã¯ã„: 0
```

å¤‰æ›ã•ã‚ŒãŸç‰©ã®ä¸­ã§çµåˆã•ã‚ŒãŸtifã¨ã¯ä½¿ç”¨ã—ãªã„ã®ã§`merge.tif, mergeLL.vrt, xmlãƒ•ã‚¡ã‚¤ãƒ«`ä»¥å¤–ã®tifãƒ•ã‚¡ã‚¤ãƒ«ã‚’ubutnuå´ã®`tool/tif_jgd2000`ã¨ `tool/tif_jgd2011`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

### GeoTIFFã®EPSGã‚³ãƒ¼ãƒ‰ã‚’çµ±ä¸€ã™ã‚‹

ç¾çŠ¶ã®tifã¯EPSGã‚³ãƒ¼ãƒ‰ãŒ4162(JGD2000)ã®ã‚‚ã®ã¨6668(JGD2011)ã®ã‚‚ã®ãŒæ··ã–ã£ã¦ã„ã¾ã™ã€‚
ã“ã®ã¾ã¾ã ã¨çµåˆã§ããªã„ã®ã§ä¸€èˆ¬çš„ã§ä¸–ç•Œæ¸¬åœ°ç³»ã®EPSG:4326ã«çµ±ä¸€ã—ã¾ã™ã€‚

```bash
cd tool
python3 tif_jgd_to_epsg4326.py
```

:::details tif_jgd_to_epsg4326.py

```python
import os
from osgeo import gdal

jgd2000_tif_path = './tif_jgd2000'
jgd2011_tif_path = './tif_jgd2011'

def main():
    # EPSGã‚³ãƒ¼ãƒ‰ã®å®šç¾©
    jgd2000_epsg = 4612
    jgd2011_epsg = 6668
    dst_epsg = 4326

    # jgd2000 ã®å‡¦ç†
    if os.path.exists(jgd2000_tif_path):
        print(f"Processing files in {jgd2000_tif_path}...")
        batch_reproject_tiffs(jgd2000_tif_path, jgd2000_epsg, dst_epsg)

    # jgd2011 ã®å‡¦ç†
    if os.path.exists(jgd2011_tif_path):
        print(f"Processing files in {jgd2011_tif_path}...")
        batch_reproject_tiffs(jgd2011_tif_path, jgd2011_epsg, dst_epsg)

def reproject_tiff(input_tiff, output_tiff, src_epsg, dst_epsg):
    src_ds = gdal.Open(input_tiff)
    if src_ds is None:
        print(f"Unable to open {input_tiff}")
        return

    dst_wkt = f'EPSG:{dst_epsg}'
    gdal.Warp(output_tiff, src_ds, dstSRS=dst_wkt, srcSRS=f'EPSG:{src_epsg}')
    print(f"Reprojected {input_tiff} to {output_tiff} with EPSG:{dst_epsg}")

def batch_reproject_tiffs(input_dir, src_epsg, dst_epsg):
    # å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã® TIFF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
    for filename in os.listdir(input_dir):
        if filename.lower().endswith('.tif') or filename.lower().endswith('.tiff'):
            input_tiff = os.path.join(input_dir, filename)
            output_tiff = os.path.join(input_dir, filename)
            reproject_tiff(input_tiff, output_tiff, src_epsg, dst_epsg)

# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸã¨ãã«ã®ã¿ main ã‚’å‘¼ã³å‡ºã™
if __name__ == "__main__":
    main()
```

:::

### 1ã¤ã®GeoTIFFã«çµåˆã™ã‚‹

```bash
cd tool
python3 merge_tif.py
```

:::details merge_tif.py

```python
import os
from osgeo import gdal

def find_tiff_files(directories):
    """è¤‡æ•°ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰TIFFãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†"""
    tiff_files = []
    for directory in directories:
        for root, _, files in os.walk(directory):
            for file in files:
                if file.endswith('.tif') or file.endswith('.tiff'):
                    tiff_files.append(os.path.join(root, file))
    return tiff_files

def create_vrt(input_files, vrt_file):
    """å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’VRTã«å¤‰æ›"""
    gdal.BuildVRT(vrt_file, input_files)

def convert_vrt_to_tiff(vrt_file, output_file):
    """VRTã‚’æœ€çµ‚çš„ãªTIFFãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›"""
    gdal.Translate(output_file, vrt_file)

def main(input_directories, output_directory):
    if not os.path.exists(output_directory):
        os.makedirs(output_directory)

    # è¤‡æ•°ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰TIFFãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†
    tiff_files = find_tiff_files(input_directories)
    if not tiff_files:
        print("No TIFF files found in the specified directories.")
        return

    vrt_file = os.path.join(output_directory, 'temporary.vrt')
    output_file = os.path.join(output_directory, 'merged_all.tif')

    # VRTä½œæˆã¨TIFFã¸ã®å¤‰æ›
    create_vrt(tiff_files, vrt_file)
    convert_vrt_to_tiff(vrt_file, output_file)

    # ä¸€æ™‚çš„ãªVRTãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    os.remove(vrt_file)

    print(f"All TIFF files from {len(input_directories)} directories have been merged into {output_file}")

input_directories = [
    './tif_jgd2000',
    './tif_jgd2011'
]
output_directory = './tif_merged'

main(input_directories, output_directory)

```

:::

çµåˆã™ã‚‹ã¨240GBãã‚‰ã„ã®å·¨å¤§ãªtifãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

çµåˆã—ãŸtifã‚’QGISã§èª­ã¿è¾¼ã¾ã›ã¦æ—¥æœ¬ã®å½¢çŠ¶ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™ã€‚
![image.png](/images/541ffbf8e5f64c/image2.png)

### Pythonã‹ã‚‰ç·¯åº¦çµŒåº¦æŒ‡å®šã§æ¨™é«˜å€¤ã‚’å–å¾—ã™ã‚‹

ã‚ã¨ã¯çµåˆã—ãŸtifã‚’gdalã«èª­ã¿è¾¼ã¾ã›ã¦ç·¯åº¦è»½åº¦ã‚’ã™ã‚‹ã ã‘ã§ã™ã€‚
æ¨™é«˜å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã€‚

```python
from osgeo import gdal, osr

class ElevationService:
    def __init__(self, tif_path):
        self.dataset = gdal.Open(tif_path, gdal.GA_ReadOnly)
        proj = self.dataset.GetProjection()
        sr = osr.SpatialReference(wkt=proj)
    def get_elevation(self, lat: int, lon: int) -> int | None:
        if self.dataset is None:
            return None
        # ç·¯åº¦ã¨çµŒåº¦ã‚’ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã«å¤‰æ›
        gt = self.dataset.GetGeoTransform()
        x = int((lon - gt[0]) / gt[1])
        y = int((lat - gt[3]) / gt[5])
        # ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã‹ã‚‰æ¨™é«˜ã‚’å–å¾—
        band = self.dataset.GetRasterBand(1)
        elevation = band.ReadAsArray(x, y, 1, 1)[0, 0]
        return elevation
    def __del__(self):
        self.dataset = None

```

ã‚¯ãƒ©ã‚¹ã®å‘¼ã³å‡ºã—å´

```python
import tool.elevation_service as elevation_service

tif_path = "./tool/tif_merged/tif_merged.tif"
elevation_service_ins = elevation_service.ElevationService(tif_path)

lat = 35.6895
lon = 139.6917
elevation = elevation_service_ins.get_elevation(lat, lon)
print(f"lat: {lat}, lon: {lon}, elevation: {elevation}")
```

ç·¯åº¦çµŒåº¦ãŒå–å¾—ã§ãã‚Œã°OK.

```python
$ python3 run.py
lat: 35.6895, lon: 139.6917, elevation: 37.900001525878906
```

## ãŠã‚ã‚Šã«

ã“ã‚Œã§åˆ¶é™ã‚’æ°—ã«ã™ã‚‹äº‹ãªãæ—¥æœ¬ä¸­ã®æ¨™é«˜å€¤ã‚’å–å¾—ã§ãã‚‹ç’°å¢ƒãŒã§ãã¾ã—ãŸã€‚
è‡ªåˆ†ãŒGISçŸ¥è­˜ãŒãªãç’°å¢ƒæ§‹ç¯‰ã«æ™‚é–“ãŒã‹ã‹ã£ãŸã®ã§åŒã˜ã‚ˆã†ãªçŠ¶æ³ã«ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°ã†ã‚Œã—ã„ã§ã™ã€‚
