---
title: "オープンデータの道幅についてめっちゃくちゃ調べた"
emoji: "🛣️"
type: "tech"
topics: ["Python", "gis", "OpenStreetMap", "GDAL"]
published: true
published_at: 2024-12-11 00:01
---

# 運転しやすい道を検索するときの条件で道幅が必要だった

運転しやすい道を検索するロジックを作る機会がありました。その時の検索条件で道幅が必須だったので色々調べました。
結論から言うと、オープンデータに道幅の判別に使えるデータはあるがデータ量が少なかったり誤データが多くまともに使えないという結論になりました。
その時に調べたことをまとめておきます。

なぜ道幅が必須なのかを簡単に説明するとこんな道を弾くためです。
![image.png](/images/4127b8580bbfcf/image.png)_酷道_

# オープンデータの道幅に関するデータ

オープンデータから道幅を判別できるかもと思った方法は5つありました。

- OpenStreetMap
  1. widthタグ
  2. lanesタグ
  3. highwayタグ
  4. yh:WIDTHタグ
- 国土地理院
  - 基盤地図情報の道幅線と中央線を組み合わせる事で道幅を計算する

## OpenStreetMap

### width タグ

名前の通り[道幅を表すタグ](https://wiki.openstreetmap.org/wiki/JA:Key:width)で計測方法は道路両側の縁石間までになっていて単位はmです。
このデータを使用できれば嬉しいのですが問題がありデータが極端に少ないです。
以下はその例で、左側がある条件に合致する道路の区間データで、右側は左側のデータからwidthタグを含むものだけを絞り込んだデータになります。
| 元データ | 元データからwidthタグを含むものを抜き出したやつ |
| ---------------------------------------------- | ----------------------------------------------- |
| ![元データ](/images/4127b8580bbfcf/Untitled.png) | ![元データからwidthタグを含むものを抜き出したやつ](/images/4127b8580bbfcf/Untitled1.png) |

ほかにも道幅の推定を表すタグに`est_width`というものがあります。
こちらは[widthタグより計測方法](https://wiki.openstreetmap.org/wiki/JA:Key:width)がゆるいのでデータが増えるのかと思いきやそうではありませんでした。

| 元データ                                          | 元データからwidthタグを含むものを抜き出したやつ                                              |
| ------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| ![元データ](/images/4127b8580bbfcf/Untitled2.png) | ![元データからest_widthタグを含むものを抜き出したやつ](/images/4127b8580bbfcf/Untitled1.png) |

### lanes タグ

こちらは[道路の車線の数を表す](https://wiki.openstreetmap.org/wiki/JA:Key:lanes)タグです。
一般的な片側１車線の道路なら2となり1度に1台しか通行できない道は1となります。
このタグで判別できるのは車線数だけなので道幅の長さを正確には判別できませんが、２車線あればある程度の道幅があると判断する事ができます。
このタグは付与されている箇所が多いです。
| 元データ | 元データからlanes=2で絞り込んだもの |
| ------------------------------------------------- | -------------------------------------------------------------------------------------------- |
| ![元データ](/images/4127b8580bbfcf/Untitled4.png) | ![元データからlanes=2で絞り込んだもの](/images/4127b8580bbfcf/Untitled5.png) |

ですが、完璧な精度ではないのでlanes=2とされている道がこんな酷道なんて事もあったりします。
![元データ](/images/4127b8580bbfcf/Untitled6.png)_lanes=2_

### highway タグ

こちらは[道路の種別を表していて重要な道路~重要でない道路を識別する](https://wiki.openstreetmap.org/wiki/JA:Key:highway)ためのタグです。
このタグは全ての道に割り当てられているのでデータ量が多いのが特徴です。
highway=residential(住宅へのアクセスとして機能する道路)は以下のような細い道なので、このタグからある程度細い道を除外する事ができます。

| highway=residential                               | StreetViewのURL                                                                                                                                                                                                                                                                                                                                                                                                             |
| ------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![original](/images/4127b8580bbfcf/Untitled7.png) | [StreetViewのURL](https://www.google.com/maps/@35.6950101,139.7563548,3a,75y,356.42h,88.07t/data=!3m7!1e1!3m5!1sKzcIO_rHlWQTTs0GH7gz_Q!2e0!6shttps:%2F%2Fstreetviewpixels-pa.googleapis.com%2Fv1%2Fthumbnail%3Fcb_client%3Dmaps_sv.tactile%26w%3D900%26h%3D600%26pitch%3D1.9270376385964596%26panoid%3DKzcIO_rHlWQTTs0GH7gz_Q%26yaw%3D356.4163354444152!7i16384!8i8192?entry=ttu&g_ep=EgoyMDI0MTEyNC4xIKXMDSoASAFQAw%3D%3D) |

### yh:WIDTH タグ

OpenStreetMapの中には企業が提供したデータも含まれおり企業が独自データと掛け合わせて分析するような時に提供してくれるらしいです。
そのデータの1つに道幅を表すyh:WIDTHタグがあります。
こちらはデータの精度はとてもよいのですがデータがとても少ないです。

| 元データ                                         | 元データからyh:WIDTHタグありで絞り込んだもの                                          |
| ------------------------------------------------ | ------------------------------------------------------------------------------------- |
| ![元データ](/images/4127b8580bbfcf/Untitled.png) | ![元データからyh:WIDTHタグありで絞り込んだもの](/images/4127b8580bbfcf/Untitled8.png) |

## 国土地理院

### 道幅縁と道中央線を組み合わせて計算する

国土地理院が提供しているデータの中に[道路縁](https://fgd.gsi.go.jp/download/menu.php)と[道路中心線](https://github.com/gsi-cyberjapan/experimental_rdcl)があり、そこから道幅を計算する事ができます。詳しい計算方法は[こちら](https://zenn.dev/kymok/articles/b976e67a874277)を御覧ください。
道幅縁とは道の縁をなぞった線の事です。これはただの線で道の内側か外側かの判別ができないので中央線とかけ合わせる事で内側の判定を行います。中央線から垂直に法線を上限に伸ばし衝突するまでの距離を計算する事で道幅の計算が行えます。

| 道幅縁のサンプル                                          | 道幅線と道中央線を重ねたもの                                           |
| --------------------------------------------------------- | ---------------------------------------------------------------------- |
| ![道幅縁のサンプル](/images/4127b8580bbfcf/Untitled9.png) | ![道幅線と道中央線を重ねたもの](/images/4127b8580bbfcf/Untitled10.png) |

| 中央線から垂直に法線をのばしたもの。赤い区間×2が道幅
| ------------------------------------------------- |
| ![中央線から垂直に法線をのばしたもの。赤い区間×2が道幅](/images/4127b8580bbfcf/Untitled11.png) |

道幅縁と中央線のデータは全道路のものが公開されているのでデータ量は膨大です。なのでこれを使えば全ての道幅を求められると思っていました。
ですが問題が2つあります。

### 問題1

道幅縁には`機械的に作図されている所`と`人の手で作図された所`の２パターンがあり、機械的に作図された所は道幅が正しくない。

| 機械的に作図されている箇所                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 人の手で細かく作図されたであろう箇所。                                       |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| ![機械的に作図されている箇所](/images/4127b8580bbfcf/image1.png)_幅は10mとなっているが[StreetView](https://www.google.co.jp/maps/@34.7636563,133.3042928,3a,75y,26.66h,88.63t/data=!3m7!1e1!3m5!1s0sCyh1ZDS20u1XsfP7qWUQ!2e0!6shttps:%2F%2Fstreetviewpixels-pa.googleapis.com%2Fv1%2Fthumbnail%3Fcb_client%3Dmaps_sv.tactile%26w%3D900%26h%3D600%26pitch%3D1.3678356622114762%26panoid%3D0sCyh1ZDS20u1XsfP7qWUQ%26yaw%3D26.655216594629294!7i13312!8i6656?entry=ttu&g_ep=EgoyMDI0MTEyNC4xIKXMDSoASAFQAw%3D%3D)で確認すると・・・・_ | ![人の手で細かく作図されたであろう箇所。](/images/4127b8580bbfcf/image2.png) |

これは予想ですが、ベースの道幅線は機械的に幅を割り当ていてそこから少しづつ手で書いて直してと思われます。というのも、機械的に割り当てられているような道は幅の平均が10m前後になる事が多いので。
なので、細かく作図されている道に関しては正しい道幅を計算できますが機械的に作図された所は計算しても意味のない値になってしまいます。

### 問題2

道が交差していると道幅縁が重なってしまい正確な幅が計算できない。
中央線から伸ばした法線が衝突するまでの距離を道幅としているのでどうしても誤差がでてしまいます。

![赤い線が中央線と道幅縁から計算した道幅](/images/4127b8580bbfcf/Untitled12.png)_赤い線が中央線と道幅縁から計算した道幅_

## まとめ

- OpenStreetMap
  - width タグ
    - 道幅の長さを表すタグ。データが少ない。
  - lanes タグ
    - 車線数を表すタグ。データが多い。道幅の長さは判別できないが広いか狭いかの判別には使える。誤データも含まれている。
  - highway タグ
    - 道路種別を表すタグ。全道に割り当てられているのでデータ量が多い。細い道を弾くのに使える。
  - yh:width タグ
    - 企業が提供した道幅の長さを表すタグ。精度は高いがデータが少ない。
- 国土地理院
  - 道幅縁と道中央線を組み合わせて道幅を計算できる
    - 道幅縁が実物の長さと異なっている事が多い。
    - 交差している道の計算は難しい

## 結論

これらのデータを酷使して道幅の絞込みを行うとデータがほぼ残りません。なおかつ誤データも含まれるので細い道も抽出されてしまいます。
なので現状のオープンデータでは道幅を正しく判別する事ができません。

# データがないなら自分で作ればいいじゃん

自分で作りました。人力作業はすべてを解決しますね。
青(2車線), オレンジ(1か2車線), 赤(1車線)
| 作成したデータ | ズーム |
| --------------------------------------------------------- | ---------------------------------------------------------------------- |
| ![作成したデータ](/images/4127b8580bbfcf/image3.png) | ![データをズーム](/images/4127b8580bbfcf/image4.png) |

データの作成方法は、目的の区間(LineString)を大量に作成するロジックを作り、そのLineStringを衛星画像と重ねて１座標ずつ目視で作成しました。
目視チェックを効率化するために専用アプリを作りました。
少しわかりにくいですが、ビュワーに目的の区間のLineStringが表示されていて右側リストにはそのポイントとマッピングを行った道幅の区分値が表示されています。
https://www.youtube.com/watch?v=9yBJeybOmWg
アプリのソースはこちらから
https://github.com/ritogk/gsi-width-mapper/tree/main

## さいごに

なんか無料で善意で作られたデータに文句ばかり言うような形になってしまい申し訳ありません。
自分でデータを作ってみてデータ作りって大変だなあと思いました。
